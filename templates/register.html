<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Registrasi Pengguna Baru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        /* Memastikan canvas mengisi lebar container-nya */
        #sig_canvas {
            width: 100%;
            /* Border default dari Tailwind diatur di elemen parent div */
        }
        /* Mengatur ukuran canvas agar terlihat baik di perangkat kecil */
        @media (max-width: 640px) {
            #sig_canvas {
                height: 150px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-xl w-full">
        <div class="bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
            <h1 class="text-3xl font-extrabold mb-8 text-center text-gray-800">✍️ Registrasi Pengguna Baru</h1>
            
            <form id="registerForm" autocomplete="off">
                <div class="mb-4">
                    <label for="nama_lengkap" class="block mb-1 text-sm font-medium text-gray-700">Nama Lengkap</label>
                    <input id="nama_lengkap" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Masukkan nama lengkap" required />
                </div>
                
                <div class="mb-4">
                    <label for="email" class="block mb-1 text-sm font-medium text-gray-700">Email</label>
                    <input id="email" type="email" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: user@domain.com" required />
                </div>
                
                <div class="mb-6">
                    <label for="departement" class="block mb-1 text-sm font-medium text-gray-700">Departemen</label>
                    <select id="departement" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm bg-white focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="" disabled selected>--- Pilih Departemen ---</option>
                        {% for d in departements %}
                            <option value="{{ d[0] }}">{{ d[1] }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-6 border-t pt-6">
                    <label class="block mb-2 text-sm font-medium text-gray-700">Tanda Tangan (Ambil 3 Contoh)</label>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg mb-3 bg-white overflow-hidden shadow-inner">
                        <canvas id="sig_canvas" width="500" height="200" class="cursor-crosshair"></canvas>
                    </div>

                    <div class="flex flex-wrap gap-3 items-center mb-3">
                        <button type="button" id="clear" class="flex-shrink-0 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition">
                            Bersihkan
                        </button>
                        <button type="button" id="capture" class="flex-shrink-0 px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition shadow-md">
                            Capture Sample
                        </button>
                        
                        <div class="ml-auto text-base font-semibold text-gray-600">
                            Samples captured: <span id="count" class="text-indigo-600">0</span>/3
                        </div>
                    </div>
                </div>
                
                <button type="submit" id="submit" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-bold text-lg hover:bg-blue-700 transition shadow-xl mt-4 disabled:bg-gray-400" disabled>
                    Submit Registrasi
                </button>
            </form>
            
            <div id="msg" class="text-sm mt-4 text-center font-medium"></div>

            <div class="mt-8 border-t pt-4 flex justify-between gap-2">
                <a href="{{ url_for('routes.admin_panel') }}" class="flex-1 text-center bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition text-sm">Kembali</a>
                <a href="{{ url_for('routes.attendance_page') }}" class="flex-1 text-center bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm">Absensi</a>
                <a href="{{ url_for('routes.upload_page') }}" class="flex-1 text-center bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition text-sm">Upload</a>
            </div>
        </div>
    </div>
    
    <script>
        const canvas = document.getElementById('sig_canvas');
        // Atur lebar canvas untuk responsif, tapi tinggi tetap
        canvas.width = canvas.offsetWidth;
        
        let signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgba(255,255,255,0)',
            penColor: 'rgb(0, 0, 0)', // Ubah warna pena menjadi hitam
            minWidth: 1.5,
            maxWidth: 2.5
        });
        
        let samples = [];
        const countSpan = document.getElementById('count');
        const msgDiv = document.getElementById('msg');
        const departementSelect = document.getElementById('departement');
        const submitButton = document.getElementById('submit');

        // Fungsi untuk mengupdate status tombol Submit
        function updateSubmitButton() {
            if (samples.length >= 3) {
                submitButton.disabled = false;
                submitButton.textContent = "Submit Registrasi";
            } else {
                submitButton.disabled = true;
                submitButton.textContent = `Capture ${3 - samples.length} sample`;
            }
        }
        
        // Inisialisasi status tombol
        updateSubmitButton();

        document.getElementById('clear').onclick = () => signaturePad.clear();

        document.getElementById('capture').onclick = () => {
            if (samples.length >= 3) {
                msgDiv.className = 'mt-4 text-center text-sm font-medium text-red-600';
                msgDiv.innerText = "Anda sudah mencapai batas maksimum 3 sample.";
                return;
            }
            if (signaturePad.isEmpty()) {
                msgDiv.className = 'mt-4 text-center text-sm font-medium text-red-600';
                msgDiv.innerText = "Tanda tangan belum diisi!";
                return;
            }
            
            // Simpan data sebagai base64 string
            samples.push(signaturePad.toData());
            signaturePad.clear();
            countSpan.innerText = samples.length;
            
            msgDiv.className = 'mt-4 text-center text-sm font-medium text-green-600';
            msgDiv.innerText = `Sample ke-${samples.length} berhasil disimpan.`;

            updateSubmitButton();
        };
        
        document.getElementById('registerForm').onsubmit = async function(e) {
            e.preventDefault();
            msgDiv.innerText = "";
            msgDiv.className = 'mt-4 text-center text-sm font-medium text-blue-600';

            if (samples.length < 3) {
                msgDiv.className = 'mt-4 text-center text-sm font-medium text-red-600';
                msgDiv.innerText = "Minimal capture 3 sample tanda tangan!";
                return;
            }
            
            let nama_lengkap = document.getElementById('nama_lengkap').value.trim();
            let email = document.getElementById('email').value.trim();
            let departement_id = departementSelect.value;
            
            if (!departement_id) {
                msgDiv.className = 'mt-4 text-center text-sm font-medium text-red-600';
                msgDiv.innerText = "Departemen harus dipilih!";
                return;
            }
            
            msgDiv.innerText = "Memproses registrasi...";
            
            submitButton.disabled = true;
            submitButton.textContent = "Loading...";

            try {
                let res = await fetch('{{ url_for("routes.api_register") }}', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({nama_lengkap, email, departement_id, signatures: samples})
                });
                
                let data = await res.json();
                
                if(data.ok) {
                    msgDiv.className = 'mt-4 text-center text-sm font-medium text-green-600';
                    msgDiv.innerText = "Registrasi berhasil! Data pengguna sudah tersimpan.";
                    
                    // Reset form setelah sukses
                    samples = [];
                    countSpan.innerText = "0";
                    signaturePad.clear();
                    document.getElementById('registerForm').reset();
                    updateSubmitButton();
                } else {
                    msgDiv.className = 'mt-4 text-center text-sm font-medium text-red-600';
                    msgDiv.innerText = "Gagal: " + data.error;
                }
            } catch (error) {
                msgDiv.className = 'mt-4 text-center text-sm font-medium text-red-600';
                msgDiv.innerText = "Terjadi kesalahan koneksi.";
            } finally {
                // Pastikan tombol diaktifkan kembali sesuai kondisi samples setelah proses
                updateSubmitButton();
            }
        };
    </script>
</body>
</html>