<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Upload File</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      /* Styling for the popup */
      .popup-container {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          transition: opacity 0.3s ease;
          opacity: 0;
          pointer-events: none;
      }
      .popup-container.show {
          opacity: 1;
          pointer-events: auto;
      }
      .popup-content {
          background-color: white;
          padding: 2rem;
          border-radius: 0.5rem;
          text-align: center;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          transform: scale(0.95);
          transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
      }
      .popup-container.show .popup-content {
          transform: scale(1);
      }
      .popup-icon {
          font-size: 3rem;
          margin-bottom: 1rem;
      }
      .popup-icon.success {
          color: #10B981; /* green-500 */
      }
      .popup-icon.error {
          color: #EF4444; /* red-500 */
      }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-6">
  <div class="max-w-md mx-auto">
    <div class="bg-white p-6 rounded shadow">
      <h2 class="font-semibold mb-2 text-lg">Upload File</h2>
      <form id="uploadForm" autocomplete="off" enctype="multipart/form-data">
        <label class="block mb-1 font-medium">Email</label>
        <input id="email" type="email" class="w-full p-2 border rounded mb-3" required />

        <label class="block mb-1 font-medium">File</label>
        <input id="fileInput" type="file" class="w-full mb-3" multiple required />

        <label class="block mb-1 font-medium">Tanda Tangan</label>
        <div class="border rounded mb-2 bg-gray-50">
          <canvas id="sig_canvas" width="400" height="200"></canvas>
        </div>

        <div class="flex gap-2 mb-3">
          <button type="button" id="clear" class="px-3 py-1 bg-gray-200 rounded">Clear</button>
          <button type="submit" id="submit" class="px-3 py-1 bg-green-600 text-white rounded">Upload</button>
        </div>
      </form>

      <div id="msg" class="text-sm mt-3"></div>
    </div>
  </div>

  <div id="popupNotification" class="popup-container">
    <div class="popup-content">
      <div id="popupIcon" class="popup-icon"></div>
      <p id="popupMessage" class="text-xl font-semibold"></p>
    </div>
  </div>

<script>
let signaturePad = new SignaturePad(document.getElementById('sig_canvas'), {
  backgroundColor: 'rgba(255,255,255,0)'
});
const msgDiv = document.getElementById('msg');
const popupNotification = document.getElementById('popupNotification');
const popupIcon = document.getElementById('popupIcon');
const popupMessage = document.getElementById('popupMessage');

function showPopup(isSuccess, message) {
    // Set icon and message based on status
    if (isSuccess) {
        popupIcon.innerHTML = '<i class="fa-solid fa-circle-check"></i>';
        popupIcon.classList.remove('error');
        popupIcon.classList.add('success');
    } else {
        popupIcon.innerHTML = '<i class="fa-solid fa-circle-xmark"></i>';
        popupIcon.classList.remove('success');
        popupIcon.classList.add('error');
    }
    popupMessage.innerText = message;
    
    // Show the popup
    popupNotification.classList.add('show');
    
    // Hide the popup after 3 seconds and refresh the page
    setTimeout(() => {
        popupNotification.classList.remove('show');
        window.location.reload();
    }, 3000);
}

document.getElementById('clear').onclick = () => signaturePad.clear();

document.getElementById('uploadForm').onsubmit = async function(e) {
  e.preventDefault();
  msgDiv.innerText = "";

  if (signaturePad.isEmpty()) {
    msgDiv.innerText = "Tanda tangan belum diisi!";
    return;
  }

  let email = document.getElementById('email').value.trim();
  let files = document.getElementById('fileInput').files;
  if (files.length === 0) {
    msgDiv.innerText = "Pilih minimal 1 file!";
    return;
  }

  let signature = signaturePad.toData();

  let formData = new FormData();
  formData.append("email", email);
  formData.append("signature", JSON.stringify(signature));
  for (let i = 0; i < files.length; i++) {
    formData.append("files", files[i]);
  }

  try {
    let res = await fetch('/api/upload', {
      method: 'POST',
      body: formData
    });
    let contentType = res.headers.get("content-type") || "";
    if (!contentType.includes("application/json")) {
      let text = await res.text();
      throw new Error("Server returned non-JSON response: " + text.slice(0, 100));
    }

    let data = await res.json();
    
    // Logika untuk menampilkan pop-up berdasarkan respons server
    if (data.ok) {
        let similarity = 0;
        if (data.distance !== undefined) {
            // Asumsi: nilai 'distance' 0 = 100% mirip, nilai 1 = 0% mirip.
            similarity = Math.max(0, (1 - parseFloat(data.distance)) * 100);
            similarity = similarity.toFixed(2);
        }
        showPopup(true, `Upload berhasil!\nKemiripan: ${similarity}%`);
    } else {
        let similarity = 0;
        if (data.distance !== undefined) {
            similarity = Math.max(0, (1 - parseFloat(data.distance)) * 100);
            similarity = similarity.toFixed(2);
        }
        showPopup(false, `Gagal: ${data.error || data.note}\nKemiripan: ${similarity}%`);
    }
  } catch(err) {
    showPopup(false, "Terjadi kesalahan pada koneksi atau server.");
    console.error(err);
  }
};
</script>
</body>
</html>