<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Absensi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Gaya kustom untuk tampilan tabel yang lebih padat dan bersih */
        .styled-table th, .styled-table td {
            padding: 1rem;
            text-align: left;
        }
        .styled-table thead th {
            text-transform: uppercase;
            font-size: 0.75rem; /* text-xs */
            letter-spacing: 0.05em; /* tracking-wider */
        }
        .styled-table tbody tr:nth-child(even) {
            background-color: #f7fafc; /* bg-gray-50 */
        }
        /* Menyesuaikan border untuk sel di tbody */
        .styled-table tbody td {
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    {% include 'seebar.html' %} 

    <div class="lg:ml-64 p-6"> 
        <header class="bg-white shadow-md rounded-lg p-4 mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-gray-800">üìä Data Absensi</h1>
            <div class="flex items-center space-x-4">
                <span class="text-gray-600 font-medium hidden sm:inline">Halo, {{ admin_username }}</span>
                <a href="{{ url_for('routes.logout') }}" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg transition duration-150 ease-in-out">
                    Logout
                </a>
            </div>
        </header>

        <div class="mb-6 flex justify-between items-center">
            <a href="{{ url_for('routes.admin_panel') }}" class="inline-flex items-center bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition duration-150 ease-in-out">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Kembali
            </a>
            <button id="export_button" class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition duration-150 ease-in-out">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Ekspor CSV
            </button>
        </div>
        
        <div class="mb-8 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üîç Filter Data Absensi</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="departement_filter" class="block text-sm font-medium text-gray-700 mb-1">Departemen:</label>
                    <select id="departement_filter" class="w-full border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <option value="">Semua Departemen</option>
                    </select>
                </div>
                <div>
                    <label for="user_filter" class="block text-sm font-medium text-gray-700 mb-1">Karyawan (Email):</label>
                    <select id="user_filter" class="w-full border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" disabled>
                        <option value="">Semua Pengguna</option>
                    </select>
                </div>
                <div>
                    <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">Mulai Tanggal:</label>
                    <input type="date" id="start_date" class="w-full border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
                <div>
                    <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">Sampai Tanggal:</label>
                    <input type="date" id="end_date" class="w-full border-gray-300 rounded-lg shadow-sm p-2.5 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-x-auto border border-gray-200">
            <h2 class="text-xl font-bold text-gray-800 p-6 border-b">Daftar Catatan Absensi</h2>
            <table class="w-full styled-table divide-y divide-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">No.</th>
                        <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
                        <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Departemen</th>
                        <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Waktu Absen</th>
                        <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                        <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Jarak (m)</th>
                        <th class="p-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Alasan</th>
                    </tr>
                </thead>
                <tbody id="attendance_table_body" class="divide-y divide-gray-200 bg-white">
                    {% for a in attendance %}
                    {% set distance = a[5]|float %}
                    <tr class="hover:bg-indigo-50 transition duration-150 cursor-pointer" data-departement="{{ a[7] }}" data-email="{{ a[2] }}" data-timestamp="{{ a[3] }}" data-id="{{ a[0] }}" data-index="{{ loop.index }}">
                        <td class="p-4 whitespace-nowrap text-sm text-gray-900 font-semibold text-center">{{ loop.index }}</td>
                        <td class="p-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ a[2] }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-600">{{ a[7] }}</td>
                        <td class="p-4 whitespace-nowrap text-sm text-gray-600">{{ a[3] }}</td>
                        <td class="p-4 whitespace-nowrap">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full
                                {% if a[4] == 'Check In' %} bg-green-100 text-green-800
                                {% elif a[4] == 'Check Out' %} bg-blue-100 text-blue-800
                                {% else %} bg-yellow-100 text-yellow-800
                                {% endif %}">
                                {{ a[4] }}
                            </span>
                        </td>
                        <td class="p-4 whitespace-nowrap text-sm">
                             <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if distance <= 50 %} bg-green-100 text-green-800 
                                {% elif distance <= 100 %} bg-yellow-100 text-yellow-800
                                {% else %} bg-red-100 text-red-800
                                {% endif %}">
                                {{ a[5] }} m
                            </span>
                        </td>
                        <td class="p-4 text-sm text-gray-600 max-w-xs overflow-hidden truncate" title="{{ a[6] }}">{{ a[6] }}</td>
                    </tr>
                    {% endfor %}
                    
                    {% if not attendance %}
                    <tr>
                        <td colspan="7" class="p-4 text-center text-gray-500">Tidak ada data absensi yang tersedia.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const departementFilter = document.getElementById('departement_filter');
            const userFilter = document.getElementById('user_filter');
            const startDateFilter = document.getElementById('start_date');
            const endDateFilter = document.getElementById('end_date');
            const attendanceTableBody = document.getElementById('attendance_table_body');
            const exportButton = document.getElementById('export_button');
            let allUsers = [];

            // Fetch departements and populate the dropdown
            try {
                const departementsResponse = await fetch('{{ url_for("routes.api_departements") }}');
                const departementsData = await departementsResponse.json();
                departementsData.departements.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.departement;
                    option.textContent = d.departement;
                    departementFilter.appendChild(option);
                });
            } catch (error) {
                console.error("Gagal memuat departemen:", error);
            }

            // Fetch all users to use for dynamic filtering
            try {
                const usersResponse = await fetch('{{ url_for("routes.api_list_users") }}');
                const usersData = await usersResponse.json();
                allUsers = usersData.users;
            } catch (error) {
                console.error("Gagal memuat daftar pengguna:", error);
            }

            function filterTable() {
                const selectedDepartement = departementFilter.value;
                const selectedUserEmail = userFilter.value;
                const startDate = startDateFilter.value ? new Date(startDateFilter.value) : null;
                const endDateValue = endDateFilter.value;
                let endDate = null;
                
                if (endDateValue) {
                    endDate = new Date(endDateValue);
                    endDate.setHours(23, 59, 59, 999); 
                }

                const rows = attendanceTableBody.getElementsByTagName('tr');
                let foundData = false;
                let visibleRowCount = 0; // Tambahkan counter untuk nomor urut

                const existingNoDataRow = document.getElementById('no_data_row');
                if (existingNoDataRow) {
                    existingNoDataRow.remove();
                }

                for (let row of rows) {
                    const departement = row.getAttribute('data-departement');
                    const email = row.getAttribute('data-email');
                    const timestampAttr = row.getAttribute('data-timestamp');
                    
                    if (!timestampAttr) continue; 
                    
                    const timestamp = new Date(timestampAttr);
                    
                    const isDepartementMatch = selectedDepartement === '' || departement === selectedDepartement;
                    const isUserMatch = selectedUserEmail === '' || email === selectedUserEmail;
                    const isDateMatch = (!startDate || timestamp >= startDate) && (!endDate || timestamp <= endDate);

                    if (isDepartementMatch && isUserMatch && isDateMatch) {
                        row.style.display = '';
                        visibleRowCount++;
                        // Update nomor urut di kolom pertama (index 0)
                        row.cells[0].textContent = visibleRowCount;
                        foundData = true;
                    } else {
                        row.style.display = 'none';
                    }
                }
                
                if (!foundData) {
                    const newRow = attendanceTableBody.insertRow();
                    newRow.id = 'no_data_row';
                    const cell = newRow.insertCell(0);
                    cell.colSpan = 7;
                    cell.className = 'p-4 text-center text-gray-500 bg-white';
                    cell.textContent = 'Tidak ada data absensi yang cocok dengan filter.';
                }
            }
            
            // --- Logika Ekspor CSV ---
            function exportToCsv() {
                const table = document.querySelector('.styled-table');
                let csv = [];
                // Kolom header diubah dari 'ID' menjadi 'No.'
                const header = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                csv.push(header.join(';')); 

                const visibleRows = Array.from(attendanceTableBody.querySelectorAll('tr')).filter(row => row.style.display !== 'none' && row.id !== 'no_data_row');

                visibleRows.forEach(row => {
                    const rowData = Array.from(row.querySelectorAll('td')).map((cell, index) => {
                        let text = cell.textContent.trim();
                        // Untuk kolom Jarak, hapus ' m' di belakangnya
                        if (index === 5) {
                            text = text.replace(' m', '').trim();
                        }
                        return (text.includes(';') || text.includes('"') || text.includes('\n')) ? `"${text.replace(/"/g, '""')}"` : text;
                    });
                    csv.push(rowData.join(';'));
                });

                const csvString = csv.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                const today = new Date().toISOString().slice(0, 10);
                link.setAttribute('href', URL.createObjectURL(blob));
                link.setAttribute('download', `data_absensi_${today}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            exportButton.addEventListener('click', exportToCsv);
            // --------------------------

            departementFilter.addEventListener('change', () => {
                const selectedDepartement = departementFilter.value;
                
                userFilter.innerHTML = '<option value="">Semua Pengguna</option>';
                userFilter.disabled = true;
                userFilter.value = '';

                if (selectedDepartement) {
                    userFilter.disabled = false;
                    const filteredUsers = allUsers.filter(u => u.departement === selectedDepartement);
                    filteredUsers.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u.email;
                        option.textContent = u.nama_lengkap + ' (' + u.email + ')'; 
                        userFilter.appendChild(option);
                    });
                }
                filterTable();
            });

            userFilter.addEventListener('change', filterTable);
            startDateFilter.addEventListener('change', filterTable);
            endDateFilter.addEventListener('change', filterTable);
            
            // Panggil filterTable saat DOMContentLoaded untuk memastikan nomor urut inisial benar
            filterTable();
        });
    </script>
</body>
</html>