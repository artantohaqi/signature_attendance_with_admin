<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Data Absensi</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
    {% include 'seebar.html' %}
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Data Absensi</h1>
        <div>
            <span class="mr-4">Hi, {{ admin_username }}</span>
            <a href="{{ url_for('routes.logout') }}" class="bg-red-500 text-white px-4 py-2 rounded">Logout</a>
        </div>
    </div>

    <div class="mb-6 flex space-x-4">
        <a href="{{ url_for('routes.admin_panel') }}" class="bg-gray-500 text-white px-4 py-2 rounded">Kembali ke Admin Panel</a>
    </div>

    <div class="mb-4 bg-white p-4 rounded-lg shadow">
        <h3 class="text-lg font-semibold mb-2">Filter Data Absensi</h3>
        <div class="flex space-x-4 flex-wrap">
            <div>
                <label for="departement_filter" class="block text-sm font-medium text-gray-700">Departemen:</label>
                <select id="departement_filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="">Semua Departemen</option>
                </select>
            </div>
            <div>
                <label for="user_filter" class="block text-sm font-medium text-gray-700">Nama:</label>
                <select id="user_filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" disabled>
                    <option value="">Semua Pengguna</option>
                </select>
            </div>
            <div>
                <label for="start_date" class="block text-sm font-medium text-gray-700">Mulai Tanggal:</label>
                <input type="date" id="start_date" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
            </div>
            <div>
                <label for="end_date" class="block text-sm font-medium text-gray-700">Sampai Tanggal:</label>
                <input type="date" id="end_date" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
            </div>
        </div>
    </div>
    
    <h2 class="text-xl font-semibold mb-2">Absensi</h2>
    <table class="w-full border">
        <thead class="bg-gray-200">
            <tr>
                <th class="p-2">ID</th><th>Email</th><th>Departemen</th><th>Waktu</th><th>Status</th><th>Distance</th><th>Reason</th>
            </tr>
        </thead>
        <tbody id="attendance_table_body">
            {% for a in attendance %}
            <tr data-departement="{{ a[7] }}" data-email="{{ a[2] }}" data-timestamp="{{ a[3] }}">
                <td class="border p-2">{{ a[0] }}</td>
                <td class="border p-2">{{ a[2] }}</td>
                <td class="border p-2">{{ a[7] }}</td>
                <td class="border p-2">{{ a[3] }}</td>
                <td class="border p-2">{{ a[4] }}</td>
                <td class="border p-2">{{ a[5] }}</td>
                <td class="border p-2">{{ a[6] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const departementFilter = document.getElementById('departement_filter');
            const userFilter = document.getElementById('user_filter');
            const startDateFilter = document.getElementById('start_date');
            const endDateFilter = document.getElementById('end_date');
            const attendanceTableBody = document.getElementById('attendance_table_body');
            let allUsers = [];

            // Fetch departements and populate the dropdown
            const departementsResponse = await fetch('{{ url_for("routes.api_departements") }}');
            const departementsData = await departementsResponse.json();
            departementsData.departements.forEach(d => {
                const option = document.createElement('option');
                option.value = d.departement;
                option.textContent = d.departement;
                departementFilter.appendChild(option);
            });

            // Fetch all users to use for dynamic filtering
            const usersResponse = await fetch('{{ url_for("routes.api_list_users") }}');
            const usersData = await usersResponse.json();
            allUsers = usersData.users;

            function filterTable() {
                const selectedDepartement = departementFilter.value;
                const selectedUserEmail = userFilter.value;
                const startDate = startDateFilter.value ? new Date(startDateFilter.value) : null;
                const endDate = endDateFilter.value ? new Date(endDateFilter.value) : null;

                const rows = attendanceTableBody.getElementsByTagName('tr');
                for (let row of rows) {
                    const departement = row.getAttribute('data-departement');
                    const email = row.getAttribute('data-email');
                    const timestamp = new Date(row.getAttribute('data-timestamp'));
                    
                    const isDepartementMatch = selectedDepartement === '' || departement === selectedDepartement;
                    const isUserMatch = selectedUserEmail === '' || email === selectedUserEmail;
                    
                    const isDateMatch = (!startDate || timestamp >= startDate) && (!endDate || timestamp <= endDate);

                    if (isDepartementMatch && isUserMatch && isDateMatch) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            }

            departementFilter.addEventListener('change', () => {
                const selectedDepartement = departementFilter.value;
                
                // Reset and disable user filter
                userFilter.innerHTML = '<option value="">Semua Pengguna</option>';
                userFilter.disabled = true;
                userFilter.value = '';

                if (selectedDepartement) {
                    userFilter.disabled = false;
                    const filteredUsers = allUsers.filter(u => u.departement === selectedDepartement);
                    filteredUsers.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u.email;
                        option.textContent = u.nama_lengkap;
                        userFilter.appendChild(option);
                    });
                }
                filterTable();
            });

            userFilter.addEventListener('change', filterTable);
            startDateFilter.addEventListener('change', filterTable);
            endDateFilter.addEventListener('change', filterTable);
        });
    </script>
</body>
</html>