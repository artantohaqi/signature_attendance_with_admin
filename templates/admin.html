<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        body {
            -webkit-overflow-scrolling: touch;
        }
        #signatureCanvas {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            touch-action: none;
        }
        .pull-to-refresh-container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 min-h-screen">
    <div class="pull-to-refresh-container">
        <div class="max-w-7xl mx-auto">
            <header class="bg-white shadow-md rounded-lg p-4 mb-6 flex justify-between items-center">
                <h1 class="text-3xl font-extrabold text-gray-800">Admin Panel</h1>
                <div class="flex items-center space-x-4">
                    <br>
                    <span class="text-gray-600 font-medium hidden sm:inline">Halo, {{ admin_username }}</span>
                    <a href="{{ url_for('routes.logout') }}" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded-lg transition duration-150 ease-in-out">
                        Logout
                    </a>
                </div>
            </header>

            <div id="addAdminContainer" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
                <h2 class="text-xl font-semibold mb-2">Tambah Admin Baru</h2>
                <form id="addAdminForm">
                    <div class="mb-4">
                        <label for="new_username" class="block text-gray-700">Username:</label>
                        <input type="text" id="new_username" name="username" class="w-full border rounded-lg p-2" required>
                    </div>
                    <div class="mb-4">
                        <label for="new_password" class="block text-gray-700">Password:</label>
                        <input type="password" id="new_password" name="password" class="w-full border rounded-lg p-2" required>
                    </div>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Tambah Admin</button>
                    <button type="button" onclick="closeAddAdminForm()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Batal</button>
                    <div id="add-admin-msg" class="mt-2 text-center"></div>
                </form>
            </div>
            
            <div class="mb-6 flex flex-wrap gap-2">
                <a href="{{ url_for('routes.departement_page') }}" class="bg-blue-500 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-blue-600">Departemen</a>
                <a href="{{ url_for('routes.absensi_page') }}" class="bg-green-500 text-white px-3 py-1.5 rounded-lg text-sm hover:bg-green-600">History Absensi</a>
            </div>

            <h2 class="text-xl font-semibold mb-2 flex items-center">
                Admins
                <button id="showAddAdminButton" class="ml-2 bg-blue-500 hover:bg-blue-600 text-white rounded-full p-1 w-8 h-8 flex items-center justify-center shadow-lg">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </h2>
            <div class="overflow-x-auto rounded-lg shadow mb-6">
                <table class="w-full text-left border-collapse table-auto">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-4 border-b">Username</th>
                            <th class="p-4 border-b w-32">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in admins %}
                        <tr id="admin-{{ a[0] }}" class="bg-white hover:bg-gray-50">
                            <td class="p-4 border-b">{{ a[1] }}</td>
                            <td class="p-4 border-b text-center whitespace-nowrap">
                                <button onclick="openEditAdminModal({{ a[0] }}, '{{ a[1] }}')" class="bg-yellow-500 text-white px-2 py-0.5 rounded-lg text-xs">Edit</button>
                                <button onclick="deleteAdmin({{ a[0] }})" class="bg-red-500 text-white px-2 py-0.5 rounded-lg text-xs">Hapus</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <h2 class="text-xl font-semibold mb-2 flex items-center">
                Users
                <a href="{{ url_for('routes.register_page') }}" class="ml-2" >
                    <button id="showAddAdminButton" 
                            class="bg-blue-500 hover:bg-blue-600 text-white rounded-full p-1 w-8 h-8 flex items-center justify-center shadow-lg">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" 
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" 
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                </a>
            </h2>
            <div class="overflow-x-auto rounded-lg shadow mb-6">
                <table class="w-full text-left border-collapse table-auto">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-4 border-b">Nama</th>
                            <th class="p-4 border-b">Email</th>
                            <th class="p-4 border-b">Departemen</th>
                            <th class="p-4 border-b text-center">TTD</th>
                            <th class="p-4 border-b text-center w-32">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in users %}
                        <tr id="user-{{ u[0] }}" class="bg-white hover:bg-gray-50">
                            <td class="p-4 border-b">{{ u[1] }}</td>
                            <td class="p-4 border-b">{{ u[2] }}</td>
                            <td class="p-4 border-b">{{ u[3] }}</td>
                            <td class="p-4 border-b text-center">
                                <button onclick="openSignatureModal({{ u[0] }})" class="bg-purple-500 text-white px-2 py-0.5 rounded-lg text-xs hover:bg-purple-600">Lihat & Edit</button>
                            </td>
                            <td class="p-4 border-b text-center whitespace-nowrap">
                                <button onclick="openEditUserModal({{ u[0] }}, '{{ u[1] }}', '{{ u[2] }}', '{{ u[3] }}')" class="bg-yellow-500 text-white px-2 py-0.5 rounded-lg text-xs hover:bg-yellow-600">Edit</button>
                                <button onclick="deleteUser({{ u[0] }})" class="bg-red-500 text-white px-2 py-0.5 rounded-lg text-xs hover:bg-red-600">Hapus</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div id="editAdminModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <h3 class="text-xl font-bold mb-4">Edit Admin</h3>
                    <form id="editAdminForm">
                        <input type="hidden" id="edit-admin-id">
                        <div class="mb-4">
                            <label for="edit-username" class="block text-gray-700">Username:</label>
                            <input type="text" id="edit-username" name="username" class="w-full border rounded-lg p-2" required>
                        </div>
                        <div class="mb-4">
                            <label for="edit-password" class="block text-gray-700">Password (Kosongkan jika tidak ingin diubah):</label>
                            <input type="password" id="edit-password" name="password" class="w-full border rounded-lg p-2">
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="closeEditAdminModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Batal</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Simpan</button>
                        </div>
                    </form>
                    <div id="edit-admin-msg" class="mt-2 text-center"></div>
                </div>
            </div>

            <div id="editUserModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <h3 class="text-xl font-bold mb-4">Edit User</h3>
                    <form id="editUserForm">
                        <input type="hidden" id="edit-user-id">
                        <div class="mb-4">
                            <label for="edit-user-fullname" class="block text-gray-700">Nama Lengkap:</label>
                            <input type="text" id="edit-user-fullname" name="fullname" class="w-full border rounded-lg p-2" required>
                        </div>
                        <div class="mb-4">
                            <label for="edit-user-email" class="block text-gray-700">Email:</label>
                            <input type="email" id="edit-user-email" name="email" class="w-full border rounded-lg p-2" required>
                        </div>
                        <div class="mb-4">
                            <label for="edit-user-departement" class="block text-gray-700">Departemen:</label>
                            <select id="edit-user-departement" name="departement_id" class="w-full border rounded-lg p-2" required></select>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="closeEditUserModal()" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Batal</button>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Simpan</button>
                        </div>
                    </form>
                    <div id="edit-user-msg" class="mt-2 text-center"></div>
                </div>
            </div>

            <div id="signatureModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
                <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Edit Tanda Tangan User: <span id="userSignatureName" class="text-blue-600"></span></h3>
                        <button onclick="closeSignatureModal()" class="text-gray-500 hover:text-gray-700">&times;</button>
                    </div>
                    <div id="signaturesList" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        </div>
                    <div class="border-t pt-4">
                        <h4 class="font-bold mb-2">Tambah 3 Tanda Tangan Baru (akan menggantikan yang lama):</h4>
                        <div class="border rounded mb-2 bg-gray-50">
                            <canvas id="signatureCanvas" width="400" height="200"></canvas>
                        </div>
                        <div class="flex gap-2 mb-3">
                            <button type="button" id="clearSignatureBtn" class="px-3 py-1 bg-gray-200 rounded">Clear</button>
                            <button type="button" id="captureSignatureBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">Capture Sample</button>
                        </div>
                        <div class="text-sm mb-2">Samples captured: <span id="signatureCount">0</span>/3</div>
                        <div class="flex justify-between mt-2">
                            <button id="cancelSignatureBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Batal</button>
                            <button id="updateSignatureBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg" disabled>Update Tanda Tangan</button>
                        </div>
                        <div id="signature-msg" class="mt-2 text-center"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const addAdminContainer = document.getElementById('addAdminContainer');
        const showAddAdminButton = document.getElementById('showAddAdminButton');
        const addForm = document.getElementById('addAdminForm');
        const editAdminModal = document.getElementById('editAdminModal');
        const editAdminForm = document.getElementById('editAdminForm');
        const editUserModal = document.getElementById('editUserModal');
        const editUserForm = document.getElementById('editUserForm');
        const signatureModal = document.getElementById('signatureModal');
        const signatureCanvas = document.getElementById('signatureCanvas');
        const signaturePad = new SignaturePad(signatureCanvas, {
            backgroundColor: 'rgba(255,255,255,0)'
        });
        const clearSignatureBtn = document.getElementById('clearSignatureBtn');
        const captureSignatureBtn = document.getElementById('captureSignatureBtn');
        const updateSignatureBtn = document.getElementById('updateSignatureBtn');
        const cancelSignatureBtn = document.getElementById('cancelSignatureBtn');
        const signatureCountSpan = document.getElementById('signatureCount');
        let currentUserId = null;
        let signatureSamples = [];

        // Fungsionalitas Pull-to-Refresh
        let startY = 0;
        let isRefreshing = false;
        const container = document.querySelector('.pull-to-refresh-container');

        container.addEventListener('touchstart', (e) => {
            startY = e.touches[0].pageY;
        });

        container.addEventListener('touchmove', (e) => {
            let deltaY = e.touches[0].pageY - startY;
            if (deltaY > 100 && container.scrollTop === 0 && !isRefreshing) {
                isRefreshing = true;
                container.style.transform = `translateY(${deltaY}px)`;
            }
        });

        container.addEventListener('touchend', () => {
            if (isRefreshing) {
                isRefreshing = false;
                container.style.transform = '';
                location.reload();
            }
        });

        // Event listeners untuk SignaturePad
        clearSignatureBtn.addEventListener('click', () => {
            signaturePad.clear();
        });

        captureSignatureBtn.addEventListener('click', () => {
            if (signaturePad.isEmpty()) {
                document.getElementById('signature-msg').innerText = "Tanda tangan belum diisi!";
                return;
            }
            signatureSamples.push(signaturePad.toData());
            signaturePad.clear();
            signatureCountSpan.innerText = signatureSamples.length;
            document.getElementById('signature-msg').innerText = "Sample ke-" + signatureSamples.length + " berhasil disimpan.";
            if (signatureSamples.length >= 3) {
                updateSignatureBtn.disabled = false;
                document.getElementById('signature-msg').innerText += " Anda bisa update tanda tangan.";
            }
        });

        updateSignatureBtn.addEventListener('click', async () => {
            if (signatureSamples.length < 3) {
                document.getElementById('signature-msg').innerText = "Minimal capture 3 sample tanda tangan!";
                return;
            }

            const res = await fetch(`/api/update_signatures/${currentUserId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ signatures: signatureSamples })
            });
            const data = await res.json();
            if (data.ok) {
                document.getElementById('signature-msg').innerText = 'Tanda tangan berhasil diupdate.';
                signatureSamples = [];
                signatureCountSpan.innerText = "0";
                signaturePad.clear();
                updateSignatureBtn.disabled = true;
                await loadUserSignatures(currentUserId);
                setTimeout(() => closeSignatureModal(), 1000);
            } else {
                document.getElementById('signature-msg').innerText = 'Gagal update tanda tangan: ' + data.error;
            }
        });

        cancelSignatureBtn.addEventListener('click', () => {
            closeSignatureModal();
        });

        function closeSignatureModal() {
            signatureModal.classList.add('hidden');
            signatureSamples = [];
            signatureCountSpan.innerText = "0";
            signaturePad.clear();
            updateSignatureBtn.disabled = true;
            document.getElementById('signature-msg').innerText = '';
        }

        async function openSignatureModal(userId) {
            currentUserId = userId;
            const userName = document.getElementById(`user-${userId}`).children[0].innerText;
            document.getElementById('userSignatureName').innerText = userName;
            await loadUserSignatures(userId);
            signatureModal.classList.remove('hidden');
        }

        async function loadUserSignatures(userId) {
            const signaturesList = document.getElementById('signaturesList');
            signaturesList.innerHTML = '';
            
            const res = await fetch(`/api/get_signatures/${userId}`);
            const data = await res.json();

            if (data.ok && data.signatures.length > 0) {
                data.signatures.forEach(sig => {
                    const sigCanvasContainer = document.createElement('div');
                    sigCanvasContainer.className = 'p-2 border rounded-lg bg-gray-50';
                    
                    const sigCanvas = document.createElement('canvas');
                    sigCanvas.width = 400;
                    sigCanvas.height = 200;
                    
                    const sigCtx = sigCanvas.getContext('2d');
                    drawSignatureOnCanvas(sig.sig_json, sigCtx);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'bg-red-500 text-white text-xs px-2 py-1 rounded-lg mt-2 hover:bg-red-600';
                    deleteBtn.innerText = 'Hapus Tanda Tangan';
                    deleteBtn.onclick = () => deleteSignature(sig.id);
                    
                    sigCanvasContainer.appendChild(sigCanvas);
                    sigCanvasContainer.appendChild(deleteBtn);
                    signaturesList.appendChild(sigCanvasContainer);
                });
            } else {
                signaturesList.innerHTML = '<p class="text-center text-gray-500">Tidak ada tanda tangan terdaftar.</p>';
            }
        }

        function drawSignatureOnCanvas(sigData, ctx) {
            if (!sigData || sigData.length === 0) return;
            
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            
            sigData.forEach(stroke => {
                if (stroke.length > 0 && Array.isArray(stroke[0]) && stroke[0].length === 2) {
                    ctx.beginPath();
                    ctx.moveTo(stroke[0][0] * ctx.canvas.width, stroke[0][1] * ctx.canvas.height);
                    for (let i = 1; i < stroke.length; i++) {
                        ctx.lineTo(stroke[i][0] * ctx.canvas.width, stroke[i][1] * ctx.canvas.height);
                    }
                    ctx.stroke();
                }
            });
        }
        
        async function deleteSignature(sigId) {
            if (confirm("Apakah Anda yakin ingin menghapus tanda tangan ini?")) {
                const res = await fetch(`/api/delete_signature/${sigId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.ok) {
                    alert('Tanda tangan berhasil dihapus.');
                    await loadUserSignatures(currentUserId);
                } else {
                    alert('Gagal menghapus tanda tangan: ' + data.error);
                }
            }
        }

        // Fungsionalitas Admin
        showAddAdminButton.addEventListener('click', () => {
            addAdminContainer.classList.remove('hidden');
        });

        function closeAddAdminForm() {
            addAdminContainer.classList.add('hidden');
            document.getElementById('add-admin-msg').textContent = '';
        }

        addForm.onsubmit = async (e) => {
            e.preventDefault();
            const username = document.getElementById('new_username').value;
            const password = document.getElementById('new_password').value;
            const msgDiv = document.getElementById('add-admin-msg');

            const res = await fetch('{{ url_for("routes.api_add_admin") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if (data.ok) {
                msgDiv.textContent = data.message;
                setTimeout(() => location.reload(), 1000);
            } else {
                msgDiv.textContent = 'Gagal: ' + data.error;
            }
        };

        function openEditAdminModal(id, username) {
            if (id === null || id === undefined || id === '') {
                console.error("ID admin tidak valid:", id);
                return;
            }
            document.getElementById('edit-admin-id').value = id;
            document.getElementById('edit-username').value = username;
            document.getElementById('edit-password').value = '';
            document.getElementById('edit-admin-msg').textContent = '';
            editAdminModal.classList.remove('hidden');
        }

        function closeEditAdminModal() {
            editAdminModal.classList.add('hidden');
        }

        editAdminForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-admin-id').value;
            const username = document.getElementById('edit-username').value;
            const password = document.getElementById('edit-password').value;
            const msgDiv = document.getElementById('edit-admin-msg');

            if (!id || !username) {
                msgDiv.textContent = "ID atau username tidak boleh kosong.";
                return;
            }

            const res = await fetch('{{ url_for("routes.api_edit_admin") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, username, password })
            });
            const data = await res.json();
            if (data.ok) {
                msgDiv.textContent = data.message;
                setTimeout(() => location.reload(), 1000);
            } else {
                msgDiv.textContent = 'Gagal: ' + data.error;
            }
        };

        async function deleteAdmin(id) {
            if (id === null || id === undefined || id === '') {
                console.error("ID admin tidak valid:", id);
                return;
            }

            if (confirm("Apakah Anda yakin ingin menghapus admin ini?")) {
                const url = `/api/delete_admin/${id}`;
                
                const res = await fetch(url, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.ok) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Gagal menghapus admin: ' + data.error);
                }
            }
        }

        // Fungsionalitas User
        let departementsData = [];

        async function loadDepartements() {
            try {
                const res = await fetch('{{ url_for("routes.api_departements") }}');
                const data = await res.json();
                departementsData = data.departements;
            } catch (e) {
                console.error(e);
                document.getElementById('edit-user-msg').textContent = "Gagal memuat daftar departemen.";
            }
        }
        loadDepartements();

        function openEditUserModal(id, fullname, email, departement) {
            if (!id) {
                console.error("ID user tidak valid:", id);
                return;
            }

            document.getElementById('edit-user-id').value = id;
            document.getElementById('edit-user-fullname').value = fullname;
            document.getElementById('edit-user-email').value = email;

            const select = document.getElementById('edit-user-departement');
            select.innerHTML = '';
            departementsData.forEach(d => {
                const option = document.createElement('option');
                option.value = d.id;
                option.textContent = d.departement;
                if (d.departement === departement) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            document.getElementById('edit-user-msg').textContent = '';
            editUserModal.classList.remove('hidden');
        }

        function closeEditUserModal() {
            editUserModal.classList.add('hidden');
        }

        editUserForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-user-id').value;
            const fullname = document.getElementById('edit-user-fullname').value;
            const email = document.getElementById('edit-user-email').value;
            const departement_id = document.getElementById('edit-user-departement').value;
            const msgDiv = document.getElementById('edit-user-msg');

            if (!id || !fullname || !email || !departement_id) {
                msgDiv.textContent = "Semua field harus diisi.";
                return;
            }

            const res = await fetch('{{ url_for("routes.api_edit_user") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, fullname, email, departement_id })
            });
            const data = await res.json();
            if (data.ok) {
                msgDiv.textContent = data.message;
                setTimeout(() => location.reload(), 1000);
            } else {
                msgDiv.textContent = 'Gagal: ' + data.error;
            }
        };

        async function deleteUser(id) {
            if (confirm("Apakah Anda yakin ingin menghapus user ini? Semua data tanda tangannya juga akan terhapus.")) {
                const res = await fetch(`/api/delete_user/${id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.ok) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Gagal menghapus user: ' + data.error);
                }
            }
        }
    </script>
</body>
</html>