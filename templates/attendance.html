<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absensi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen p-6">
  <div class="max-w-md mx-auto">
    <div class="bg-white p-6 rounded shadow">
      <h2 class="font-semibold mb-2 text-lg">Absensi</h2>
      <form id="attendanceForm" autocomplete="off">
        <!-- Email -->
        <label class="block mb-1 font-medium">Email</label>
        <input id="email" type="email" class="w-full p-2 border rounded mb-3" required />

        <!-- Alasan Terlambat -->
        <div id="reasonBox" class="hidden">
          <label class="block mb-1 font-medium text-red-600">Alasan Terlambat</label>
          <textarea id="reason" rows="3" class="w-full p-2 border rounded mb-3"></textarea>
        </div>

        <!-- Signature -->
        <label class="block mb-1 font-medium">Tanda Tangan</label>
        <div class="border rounded mb-2 bg-gray-50">
          <canvas id="sig_canvas" width="400" height="200"></canvas>
        </div>

        <!-- Buttons -->
        <div class="flex gap-2 mb-3">
          <button type="button" id="clear" class="px-3 py-1 bg-gray-200 rounded">Clear</button>
          <button type="submit" id="submit" class="px-3 py-1 bg-green-600 text-white rounded">Absen</button>
        </div>
      </form>

      <!-- Messages -->
      <div id="msg" class="text-sm mt-3"></div>
      <div class="mt-4">
        <a href="/register" class="text-blue-600">Ke Halaman Registrasi</a>
      </div>
    </div>
  </div>

<script>
let signaturePad = new SignaturePad(document.getElementById('sig_canvas'), {
  backgroundColor: 'rgba(255,255,255,0)'
});
const msgDiv = document.getElementById('msg');
const reasonBox = document.getElementById('reasonBox');
const reasonInput = document.getElementById('reason');

// cek jam saat halaman dibuka
function updateReasonBox() {
  let now = new Date();
  let batasAwal = new Date(); batasAwal.setHours(7,30,0,0);
  let batasAkhir = new Date(); batasAkhir.setHours(16,30,0,0);

  if (now >= batasAwal && now <= batasAkhir) {
    reasonBox.classList.remove("hidden");
  } else {
    reasonBox.classList.add("hidden");
  }
}
updateReasonBox();

document.getElementById('clear').onclick = () => signaturePad.clear();

document.getElementById('attendanceForm').onsubmit = async function(e) {
  e.preventDefault();
  msgDiv.innerText = "";
  if (signaturePad.isEmpty()) {
    msgDiv.innerText = "Tanda tangan belum diisi!";
    return;
  }

  let email = document.getElementById('email').value.trim();
  let signature = signaturePad.toData();
  
  // cek jam saat submit
  let now = new Date();
  let batasAwal = new Date(); batasAwal.setHours(7,30,0,0);
  let batasAkhir = new Date(); batasAkhir.setHours(16,30,0,0);

  if (now < batasAwal) {
    msgDiv.innerText = "Absensi belum dibuka. Mulai jam 07:30.";
    return;
  }

  if (now > batasAkhir) {
    msgDiv.innerText = "Absensi sudah ditutup jam 16:30.";
    return;
  }

  let reason = "";
  if (now > batasAwal && now <= batasAkhir) {
    reason = reasonInput.value.trim();
    if (!reason) {
      msgDiv.innerText = "Anda terlambat, isi alasan terlebih dahulu!";
      return;
    }
  }

  let res = await fetch('/api/attendance', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({email, signature, reason})
  });
  let data = await res.json();

  if(data.ok) {
    msgDiv.innerText = "Absensi berhasil: " + (data.note || "");
    signaturePad.clear();
    document.getElementById('attendanceForm').reset();
    reasonBox.classList.add("hidden");
  } else {
    msgDiv.innerText = "Gagal: " + (data.error || data.note);
  }
};
</script>
</body>
</html>
